<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quorum Site</title>
<style>
  body { margin:0; font-family:'Segoe UI',sans-serif; background:#1e1e2f; color:#fff; transition:0.3s; }
  body.light { background:#f0f0f0; color:#111; }
  #root { max-width:900px; margin:auto; padding:20px; transition:0.3s; }
  .tabs { display:flex; margin-bottom:20px; flex-wrap:wrap; gap:5px; }
  .tab { flex:1; padding:10px; cursor:pointer; text-align:center; background:#2e2e4f; border-radius:10px 10px 0 0; transition:0.2s; min-width:90px; text-transform:uppercase; font-weight:bold; }
  .tab:hover { background:#3e3e6f; }
  .tab.active { background:#4e4e7f; }
  body.light .tab { background:#ddd; color:#111; }
  body.light .tab.active { background:#bbb; color:#111; }
  .chat-window { height:350px; overflow-y:auto; background:#2e2e4f; padding:10px; border-radius:10px; margin-bottom:10px; transition:0.3s; display:flex; flex-direction:column; }
  body.light .chat-window { background:#eee; color:#111; }
  .chat-message { margin-bottom:8px; display:flex; justify-content:flex-start; flex-wrap:wrap; position:relative; }
  .chat-bubble { padding:8px 12px; border-radius:12px; max-width:70%; word-wrap:break-word; box-shadow: 0 2px 6px rgba(0,0,0,0.3); transition:0.2s; }
  .chat-bubble:hover { opacity:0.9; }
  .chat-username { font-weight:bold; margin-right:5px; }
  .chat-time { font-size:0.8em; color:#aaa; margin-left:10px; white-space:nowrap; }
  input, button { padding:8px; font-size:16px; border:none; border-radius:5px; }
  input { flex:1; }
  button { background:#4e4e7f; color:#fff; cursor:pointer; transition:0.2s; }
  button:hover { background:#5e5e9f; }
  body.light button { background:#999; color:#111; }
  .chat-input { display:flex; gap:5px; margin-bottom:10px; }
  table { width:100%; border-collapse: collapse; background:#2e2e4f; border-radius:5px; overflow:hidden; transition:0.3s; }
  th, td { padding:10px; border-bottom:1px solid #444; text-align:left; }
  th { background:#3e3e5f; }
  body.light table, body.light th, body.light td { background:#ddd; color:#111; border-bottom:1px solid #bbb; }
  .login-box { max-width:350px; margin:auto; background:#2e2e4f; padding:20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.4); }
  .login-box input { margin-bottom:10px; width:100%; }
  .login-box button { width:100%; }
  .edit-btn, .delete-btn { margin-left:5px; font-size:0.8em; padding:2px 6px; border-radius:4px; }
  .edit-btn { background:#f0a; color:#fff; }
  .delete-btn { background:#f55; color:#fff; }
  .admin-badge { border:2px solid gold; padding:2px 4px; border-radius:4px; margin-left:5px; font-size:0.8em; color:gold; }
  @media(max-width:600px){ .chat-bubble{max-width:85%;} table, th, td{font-size:14px;} }
</style>
</head>
<body>
<div id="root"></div>

<!-- React & Babel -->
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Firebase Compat -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script type="text/babel">
// --------- Firebase Config ---------
const firebaseConfig = {
  apiKey: "AIzaSyCku0BT6vXyXnrCZIPjt2I51uwV1oBJfv0",
  authDomain: "teachers-quorum-site-58b5a.firebaseapp.com",
  projectId: "teachers-quorum-site-58b5a",
  storageBucket: "teachers-quorum-site-58b5a.firebasestorage.app",
  messagingSenderId: "80149867472",
  appId: "1:80149867472:web:e00274042a5f14a36fe7d5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

// --------- React App ---------
function App() {
  const [tab,setTab]=React.useState('chat');
  const [user,setUser]=React.useState(null);
  const [messages,setMessages]=React.useState([]);
  const [schedule,setSchedule]=React.useState([]);
  const [dark,setDark]=React.useState(true);
  const [loginEmail,setLoginEmail]=React.useState('');
  const [loginPassword,setLoginPassword]=React.useState('');
  const [username,setUsername]=React.useState('');
  const [input,setInput]=React.useState('');
  const chatWindowRef=React.useRef();

  React.useEffect(()=>{ document.body.className = dark ? '' : 'light'; },[dark]);

  React.useEffect(()=>{
    auth.onAuthStateChanged(u=>{
      if(u){ setUser(u); setUsername(u.displayName || u.email.split('@')[0]); }
      else{ setUser(null); setUsername(''); }
    });
  },[]);

  React.useEffect(()=>{
    const chatRef = db.ref('messages');
    chatRef.on('value', snapshot=>{
      const data = snapshot.val() || {};
      const chatArray = Object.entries(data).map(([key, val])=>({key, ...val})).sort((a,b)=>a.time-b.time);
      setMessages(chatArray);
    });
  },[]);

  React.useEffect(()=>{
    if(chatWindowRef.current) chatWindowRef.current.scrollTop = chatWindowRef.current.scrollHeight;
  },[messages]);

  React.useEffect(()=>{
    const sheetUrl='https://docs.google.com/spreadsheets/d/e/2PACX-1vR48S8GQkZM2S1PMXsXjE48eGwryPuD5efwj2_RCHPsbCiMAScSiH7qBNecZk_mCQqE6h5wKB6lHJYG/pub?output=csv';
    fetch(sheetUrl).then(r=>r.text()).then(csvText=>{
      const rows = csvText.trim().split('\n').map(r=>r.split(','));
      setSchedule(rows);
    });
  },[]);

  const sendMessage=()=>{
    if(!input.trim()) return;
    const msg = { user: username, uid: user.uid, text: input.trim(), time: Date.now() };
    db.ref('messages').push(msg);
    setInput('');
  };

  const deleteMessage=(msgUid,key)=>{
    if(user.uid===msgUid || user.email==='sterlingwbeck@gmail.com')
      db.ref('messages/'+key).remove();
  };

  const editMessage=(msgUid,key,oldText)=>{
    if(user.uid===msgUid){
      const newText = prompt('Edit your message:', oldText);
      if(newText!==null) db.ref('messages/'+key).update({text:newText});
    }
  };

  const login=async()=>{
    try{
      await auth.signInWithEmailAndPassword(loginEmail,loginPassword);
    }catch(err){
      if(err.code==='auth/user-not-found'){
        await auth.createUserWithEmailAndPassword(loginEmail,loginPassword);
        const currentUser=auth.currentUser;
        await currentUser.updateProfile({displayName: loginEmail.split('@')[0]});
      } else alert(err.message);
    }
  };

  const logout=()=>{ auth.signOut(); };

  const formatTime=ts=>{ const d=new Date(ts); return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); };
  const userColor=user=>{
    let hash=0; for(let i=0;i<user.length;i++){ hash=user.charCodeAt(i)+((hash<<5)-hash); }
    const c=(hash&0x00FFFFFF).toString(16).toUpperCase(); return '#'+('00000'+c).slice(-6);
  };

  if(!user) return <div className="login-box">
    <h2>Login / Register</h2>
    <input placeholder="Email" value={loginEmail} onChange={e=>setLoginEmail(e.target.value)}/>
    <input type="password" placeholder="Password" value={loginPassword} onChange={e=>setLoginPassword(e.target.value)}/>
    <button onClick={login}>Login / Register</button>
  </div>;

  return (
    <div>
      <div className="tabs">
        <div className={`tab ${tab==='chat'?'active':''}`} onClick={()=>setTab('chat')}>Chat</div>
        <div className={`tab ${tab==='schedule'?'active':''}`} onClick={()=>setTab('schedule')}>Schedule</div>
        <div className="tab" onClick={()=>setDark(!dark)}>{dark?'Light Mode':'Dark Mode'}</div>
        <div className="tab" onClick={logout}>Logout</div>
      </div>

      {tab==='chat' && <>
        <div className="chat-window" ref={chatWindowRef}>
          {messages.map(m=>(
            <div key={m.key} className="chat-message">
              <div className="chat-bubble" style={{backgroundColor:userColor(m.user)}}>
                <span className="chat-username">{m.user}</span>
                {m.email==='sterlingwbeck@gmail.com' && <span className="admin-badge">ADMIN</span>}:
                {m.text}
                <span className="chat-time">{formatTime(m.time)}</span>
                {(m.uid===user.uid || user.email==='sterlingwbeck@gmail.com') && <>
                  <button className="edit-btn" onClick={()=>editMessage(m.uid,m.key,m.text)}>Edit</button>
                  <button className="delete-btn" onClick={()=>deleteMessage(m.uid,m.key)}>Delete</button>
                </>}
              </div>
            </div>
          ))}
        </div>
        <div className="chat-input">
          <input placeholder="Type a message..." value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>e.key==='Enter'?sendMessage():null}/>
          <button onClick={sendMessage}>Send</button>
        </div>
      </>}

      {tab==='schedule' && <table>
        <thead><tr>{schedule[0] && schedule[0].map((h,i)=><th key={i}>{h}</th>)}</tr></thead>
        <tbody>{schedule.slice(1).map((row,i)=><tr key={i}>{row.map((c,j)=><td key={j}>{c}</td>)}</tr>)}</tbody>
      </table>}
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
