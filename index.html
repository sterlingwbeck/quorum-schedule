<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teachers Quorum</title>
<style>
  :root {
    --primary: #5c6bc0;
    --accent: #7e57c2;
    --bg: #f5f7fb;
    --card-bg: #ffffff;
  }

  * { box-sizing: border-box; margin:0; padding:0; }
  body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color:#333; }
  header { background: linear-gradient(90deg, var(--primary), var(--accent)); color:white; padding:1rem 2rem; text-align:center; }
  main { display:grid; grid-template-columns:1fr 1fr; gap:2rem; padding:2rem; }
  section { background: var(--card-bg); border-radius:12px; padding:1.5rem; box-shadow:0 4px 8px rgba(0,0,0,0.05); }
  h2 { margin-bottom:1rem; color: var(--primary); }
  input { width:100%; padding:0.5rem; margin:0.3rem 0; border:1px solid #ccc; border-radius:6px; }
  button { background: var(--primary); color:white; border:none; padding:0.6rem 1rem; border-radius:6px; cursor:pointer; margin-top:0.5rem; }
  button:hover { background: var(--accent); }
  #messages { border:1px solid #ddd; padding:0.5rem; height:300px; overflow-y:auto; background:#fafafa; border-radius:6px; margin-bottom:1rem; }
  .message { padding:0.4rem 0.6rem; margin:0.3rem 0; background:#e8eaf6; border-radius:6px; position:relative; }
  .message.you { background:#d1c4e9; }
  .message .author { font-weight:bold; margin-right:0.4rem; }
  #signup-page { display:none; padding:2rem; max-width:400px; margin:4rem auto; background: var(--card-bg); border-radius:12px; box-shadow:0 4px 8px rgba(0,0,0,0.1); }
  #signup-page input { margin-bottom:10px; }
  #schedule-frame { width:100%; height:300px; border:none; border-radius:6px; }
  #logout-btn { float:right; background:#d32f2f; margin-top:-40px; }
  #logout-btn:hover { background:#b71c1c; }
</style>
</head>
<body>
<header>
  <h1>Teachers Quorum</h1>
  <p>Assignments & Chat Hub</p>
  <button id="logout-btn" style="display:none;" onclick="logout()">Logout</button>
</header>

<!-- Signup Page -->
<div id="signup-page">
  <h2>Sign Up</h2>
  <input id="signup-name" type="text" placeholder="Full Name" />
  <input id="signup-email" type="email" placeholder="Email" />
  <input id="signup-password" type="password" placeholder="Password" />
  <button onclick="signup()">Create Account</button>
</div>

<!-- Main App -->
<main id="main-content" style="display:none;">
  <section id="assignments">
    <h2>Schedule</h2>
    <iframe id="schedule-frame" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vR48S8GQkZM2S1PMXsXjE48eGwryPuD5efwj2_RCHPsbCiMAScSiH7qBNecZk_mCQqE6h5wKB6lHJYG/pub?output=html"></iframe>
  </section>

  <section id="chat">
    <h2>Chat</h2>
    <div id="messages"></div>
    <input id="chat-input" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
    <button id="clear-chat" style="display:none;" onclick="clearChat()">Clear Chat</button>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

// Your Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCHvfjuoQUP5E3AeNRty2RxJeUD-vOL_bI",
  authDomain: "teachers-quorum-site.firebaseapp.com",
  databaseURL: "https://teachers-quorum-site-default-rtdb.firebaseio.com",
  projectId: "teachers-quorum-site",
  storageBucket: "teachers-quorum-site.firebasestorage.app",
  messagingSenderId: "1036871246524",
  appId: "1:1036871246524:web:4a4dc6bd9e62f03d9a26b9",
  measurementId: "G-ZGEJ03HH08"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let currentUserName = "";
let currentUserUid = "";

// Auth state
onAuthStateChanged(auth, (user)=>{
  if(user){
    currentUserName = user.displayName || user.email.split('@')[0];
    currentUserUid = user.uid;
    document.getElementById("signup-page").style.display = "none";
    document.getElementById("main-content").style.display = "grid";
    document.getElementById("logout-btn").style.display = "inline-block";
    if(user.email === "sterlingwbeck@gmail.com"){
      document.getElementById("clear-chat").style.display = "inline-block";
    }
    loadChat();
  }else{
    document.getElementById("signup-page").style.display = "block";
    document.getElementById("main-content").style.display = "none";
    document.getElementById("logout-btn").style.display = "none";
  }
});

// Signup
window.signup = async function(){
  const name = document.getElementById("signup-name").value;
  const email = document.getElementById("signup-email").value;
  const password = document.getElementById("signup-password").value;
  if(!name || !email || !password){ alert("Fill all fields!"); return; }
  try{
    const cred = await createUserWithEmailAndPassword(auth,email,password);
    await updateProfile(cred.user,{displayName:name});
    await push(ref(db,'users/'),{uid:cred.user.uid,name,email});
  }catch(e){ alert(e.message);}
};

// Logout
window.logout = function(){
  signOut(auth);
};

// Chat
window.sendMessage = function(){
  const input = document.getElementById("chat-input");
  if(input.value.trim()){
    push(ref(db,'messages'),{text:input.value,author:currentUserName,uid:currentUserUid});
    input.value="";
  }
};

function loadChat(){
  onValue(ref(db,'messages'),(snap)=>{
    const msgBox = document.getElementById("messages");
    msgBox.innerHTML="";
    snap.forEach(child=>{
      const m = child.val();
      const div = document.createElement("div");
      div.className="message"+(m.uid===currentUserUid?" you":"");
      div.dataset.key=child.key;
      div.innerHTML=`<span class="author">${m.author}:</span> ${m.text}`;
      // Right-click / long-press for edit/delete
      div.addEventListener("contextmenu",e=>{
        e.preventDefault();
        if(m.uid===currentUserUid){
          const newText=prompt("Edit your message:",m.text);
          if(newText===null) return;
          else if(newText==="") remove(ref(db,'messages/'+child.key));
          else update(ref(db,'messages/'+child.key),{text:newText});
        }
      });
      msgBox.appendChild(div);
    });
    msgBox.scrollTop = msgBox.scrollHeight;
  });
}

// Admin clear chat
window.clearChat = function(){
  if(confirm("Are you sure you want to clear all messages?")){
    remove(ref(db,'messages'));
  }
};

</script>
</body>
</html>
