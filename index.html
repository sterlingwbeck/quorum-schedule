<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teachers Quorum</title>
<style>
:root {
  --primary: #5c6bc0;
  --accent: #7e57c2;
  --bg: #f5f7fb;
  --card-bg: #ffffff;
}

* { box-sizing: border-box; margin:0; padding:0; }
body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color:#333; }

header { background: linear-gradient(90deg, var(--primary), var(--accent)); color:white; padding:1rem 2rem; text-align:center; }
header h1 { margin-bottom:0.2rem; }
header p { font-size:0.9rem; margin-bottom:0.5rem; }
#logout-btn { float:right; background:#d32f2f; margin-top:-40px; }
#logout-btn:hover { background:#b71c1c; }

.container { display:flex; justify-content:center; align-items:center; min-height:80vh; }
form { background: var(--card-bg); padding:2rem; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); width:320px; }
input { width:100%; padding:0.6rem; margin:0.5rem 0; border-radius:6px; border:1px solid #ccc; }
button { width:100%; padding:0.6rem; margin-top:0.5rem; border:none; border-radius:6px; background: var(--primary); color:white; cursor:pointer; }
button:hover{ background: var(--accent); }
a { display:block; text-align:center; margin-top:1rem; color:var(--primary); text-decoration:none; }
a:hover { text-decoration:underline; }

#main-app { display:none; padding:2rem; grid-template-columns:1fr 1fr; gap:2rem; display:grid; }
section { background: var(--card-bg); border-radius:12px; padding:1.5rem; box-shadow:0 4px 8px rgba(0,0,0,0.05); }
h2 { margin-bottom:1rem; color: var(--primary); }
#messages { border:1px solid #ddd; padding:0.5rem; height:300px; overflow-y:auto; background:#fafafa; border-radius:6px; margin-bottom:1rem; }
.message { padding:0.4rem 0.6rem; margin:0.3rem 0; background:#e8eaf6; border-radius:6px; position:relative; }
.message.you { background:#d1c4e9; }
.message .author { font-weight:bold; margin-right:0.4rem; }
#chat-input { margin-bottom:0.5rem; }
#clear-chat { display:none; }
#schedule-frame { width:100%; height:300px; border:none; border-radius:6px; }
</style>
</head>
<body>

<header>
  <h1>Teachers Quorum</h1>
  <p>Assignments & Chat Hub</p>
  <button id="logout-btn" onclick="logout()">Logout</button>
</header>

<!-- Login Form -->
<div id="login-page" class="container">
  <form id="loginForm">
    <h2>Login</h2>
    <input id="login-email" type="email" placeholder="Email" required />
    <input id="login-password" type="password" placeholder="Password" required />
    <button type="submit">Login</button>
    <a href="#" onclick="showSignup()">Create Account</a>
  </form>
</div>

<!-- Signup Form -->
<div id="signup-page" class="container" style="display:none;">
  <form id="signupForm">
    <h2>Sign Up</h2>
    <input id="signup-name" type="text" placeholder="Full Name" required />
    <input id="signup-email" type="email" placeholder="Email" required />
    <input id="signup-password" type="password" placeholder="Password" required />
    <button type="submit">Sign Up</button>
    <a href="#" onclick="showLogin()">Back to Login</a>
  </form>
</div>

<!-- Main App -->
<div id="main-app">
  <section id="assignments">
    <h2>Schedule</h2>
    <iframe id="schedule-frame" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vR48S8GQkZM2S1PMXsXjE48eGwryPuD5efwj2_RCHPsbCiMAScSiH7qBNecZk_mCQqE6h5wKB6lHJYG/pub?output=html"></iframe>
  </section>

  <section id="chat">
    <h2>Chat</h2>
    <div id="messages"></div>
    <input id="chat-input" placeholder="Type a message..." />
    <button onclick="sendMessage()">Send</button>
    <button id="clear-chat" onclick="clearChat()">Clear Chat</button>
  </section>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCHvfjuoQUP5E3AeNRty2RxJeUD-vOL_bI",
  authDomain: "teachers-quorum-site.firebaseapp.com",
  databaseURL: "https://teachers-quorum-site-default-rtdb.firebaseio.com",
  projectId: "teachers-quorum-site",
  storageBucket: "teachers-quorum-site.firebasestorage.app",
  messagingSenderId: "1036871246524",
  appId: "1:1036871246524:web:4a4dc6bd9e62f03d9a26b9",
  measurementId: "G-ZGEJ03HH08"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

let currentUserName = "";
let currentUserUid = "";

// Show login or signup
function showSignup(){ document.getElementById("login-page").style.display="none"; document.getElementById("signup-page").style.display="flex"; }
function showLogin(){ document.getElementById("signup-page").style.display="none"; document.getElementById("login-page").style.display="flex"; }

// Auth state
onAuthStateChanged(auth,(user)=>{
  if(user){
    currentUserName = user.displayName || user.email.split('@')[0];
    currentUserUid = user.uid;
    document.getElementById("login-page").style.display="none";
    document.getElementById("signup-page").style.display="none";
    document.getElementById("main-app").style.display="grid";
    document.getElementById("logout-btn").style.display="inline-block";
    if(user.email==="sterlingwbeck@gmail.com") document.getElementById("clear-chat").style.display="inline-block";
    loadChat();
  }else{
    document.getElementById("main-app").style.display="none";
    document.getElementById("logout-btn").style.display="none";
    document.getElementById("login-page").style.display="flex";
  }
});

// Signup
document.getElementById("signupForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const name = document.getElementById("signup-name").value;
  const email = document.getElementById("signup-email").value;
  const password = document.getElementById("signup-password").value;
  try{
    const cred = await createUserWithEmailAndPassword(auth,email,password);
    await updateProfile(cred.user,{displayName:name});
    await push(ref(db,'users/'),{uid:cred.user.uid,name,email});
    alert("Account created! Please login.");
    showLogin();
  }catch(err){ alert(err.message); }
});

// Login
document.getElementById("loginForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const email = document.getElementById("login-email").value;
  const password = document.getElementById("login-password").value;
  try{
    await signInWithEmailAndPassword(auth,email,password);
  }catch(err){ alert("Incorrect email or password."); }
});

// Logout
function logout(){ signOut(auth); }

// Chat functions
function sendMessage(){
  const input = document.getElementById("chat-input");
  if(input.value.trim()){
    push(ref(db,'messages'),{text:input.value,author:currentUserName,uid:currentUserUid});
    input.value="";
  }
}

function loadChat(){
  onValue(ref(db,'messages'),snap=>{
    const msgBox=document.getElementById("messages");
    msgBox.innerHTML="";
    snap.forEach(child=>{
      const m = child.val();
      const div = document.createElement("div");
      div.className="message"+(m.uid===currentUserUid?" you":"");
      div.dataset.key=child.key;
      div.innerHTML=`<span class="author">${m.author}:</span> ${m.text}`;
      div.addEventListener("contextmenu",e=>{
        e.preventDefault();
        if(m.uid===currentUserUid){
          const newText=prompt("Edit your message:",m.text);
          if(newText===null) return;
          else if(newText==="") remove(ref(db,'messages/'+child.key));
          else update(ref(db,'messages/'+child.key),{text:newText});
        }
      });
      msgBox.appendChild(div);
    });
    msgBox.scrollTop = msgBox.scrollHeight;
  });
}

// Admin clear chat
function clearChat(){
  if(confirm("Are you sure you want to clear all messages?")){
    remove(ref(db,'messages'));
  }
}
</script>

</body>
</html>
