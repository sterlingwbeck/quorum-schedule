<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Quorum Schedule — Live</title>
  <!-- React + ReactDOM + Babel for single-file convenience (works on GitHub Pages) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#60a5fa}
    html,body,#root{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:linear-gradient(180deg,#071124 0%, #051025 100%);color:#dbe7f7}
    .container{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:20px}
    .card{background:rgba(255,255,255,0.03);border-radius:12px;padding:14px;box-shadow:0 6px 20px rgba(2,6,23,0.6)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    input,select,textarea,button{font-size:14px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:14px}
    th{position:sticky;top:0;background:rgba(255,255,255,0.02)}
    .muted{color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px}
    .chat-list{max-height:320px;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:8px}
    .chat-thread{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
    .small{font-size:13px}
    @media(max-width:760px){.controls{flex-direction:column}}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useState,useEffect,useRef} = React;

    // CONFIG: Paste your published CSV URL here (provided by you)
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR48S8GQkZM2S1PMXsXjE48eGwryPuD5efwj2_RCHPsbCiMAScSiH7qBNecZk_mCQqE6h5wKB6lHJYG/pub?output=csv";

    // OPTIONAL: If you want a real-time chat stored server-side, provide Firebase config below.
    // To use Firebase you must create a Firebase project, enable Firestore, and paste the config object exactly.
    // If FIREBASE_CONFIG is null, the app will use localStorage for chat threads (private to your browser).
    const FIREBASE_CONFIG = null; // <-- replace `null` with your firebase config object to enable remote chat

    // Basic CSV parsing that handles quoted fields
    function parseCSV(text, delimiter = ','){
      const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n').filter(l=>l.trim()!=='');
      const rows = [];
      for(const line of lines){
        const fields = [];
        let cur='';let inQuotes=false;
        for(let i=0;i<line.length;i++){
          const ch = line[i];
          if(ch==='"'){
            if(inQuotes && line[i+1]==='"'){cur+='"';i++;}
            else inQuotes=!inQuotes;
          } else if(ch===delimiter && !inQuotes){fields.push(cur);cur='';}
          else cur+=ch;
        }
        fields.push(cur);
        rows.push(fields);
      }
      const header = rows[0] || [];
      const data = rows.slice(1).map(r => {
        const obj = {};
        for(let i=0;i<header.length;i++) obj[header[i] || `col${i+1}`] = r[i] || '';
        return obj;
      });
      return {header,data};
    }

    function useAutoFetch(url, intervalMs = 0){
      const [payload,setPayload] = useState({loading:true,error:null,header:[],data:[]});
      useEffect(()=>{
        let mounted = true;
        async function fetchNow(){
          try{
            const res = await fetch(url, {cache: 'no-store'});
            if(!res.ok) throw new Error(res.status+' '+res.statusText);
            const text = await res.text();
            const parsed = parseCSV(text);
            if(mounted) setPayload({loading:false,error:null,header:parsed.header,data:parsed.data});
          }catch(e){ if(mounted) setPayload({loading:false,error:String(e),header:[],data:[]}); }
        }
        fetchNow();
        if(intervalMs>0){
          const i = setInterval(fetchNow, intervalMs);
          return ()=>{mounted=false;clearInterval(i)};
        }
        return ()=>{mounted=false};
      },[url,intervalMs]);
      return payload;
    }

    // LocalStorage-based chat store (fallback)
    const STORAGE_KEY = 'quorum_site_chats_v1';
    function loadChats(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch{return []}
    }
    function saveChats(chats){ localStorage.setItem(STORAGE_KEY, JSON.stringify(chats)); }

    function App(){
      const feed = useAutoFetch(CSV_URL, 60000); // refetch every minute when open
      const [query, setQuery] = useState('');
      const [delimiter, setDelimiter] = useState(',');

      // contact form state
      const [contact, setContact] = useState({name:'',email:'',subject:'Question about schedule',message:''});

      // chats
      const [chats, setChatsState] = useState(loadChats());
      const [activeThreadId, setActiveThreadId] = useState(null);
      const chatMessageRef = useRef();

      useEffect(()=>{ saveChats(chats); },[chats]);

      function filteredRows(){
        if(!feed.data) return [];
        if(!query) return feed.data;
        const q = query.toLowerCase();
        return feed.data.filter(row => Object.values(row).some(v=>String(v).toLowerCase().includes(q)));
      }

      function startThread(name, email, initial){
        const t = {id: 't_'+Date.now(), name, email, created: new Date().toISOString(), messages:[{from:'visitor',text:initial,time:new Date().toISOString()}]};
        setChatsState([t,...chats]);
        setActiveThreadId(t.id);
      }

      function postMessageToActive(text, from='owner'){
        if(!activeThreadId) return; const copy = chats.slice();
        const idx = copy.findIndex(c=>c.id===activeThreadId); if(idx===-1) return;
        copy[idx].messages.push({from,text,time:new Date().toISOString()});
        copy[idx].lastUpdated = new Date().toISOString();
        setChatsState(copy);
      }

      function exportChats(){
        const data = JSON.stringify(chats, null, 2);
        const blob = new Blob([data], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='quorum_chats.json'; a.click(); URL.revokeObjectURL(url);
      }

      function emailOwner(){
        // prefill mailto with basic info (mailto body might have size limits)
        const subject = encodeURIComponent(contact.subject||'Question about schedule');
        const body = encodeURIComponent(`Name: ${contact.name}\nEmail: ${contact.email}\n\n${contact.message}`);
        window.location.href = `mailto:sterlingwbeck@gmail.com?subject=${subject}&body=${body}`;
      }

      return (
        <div className="container">
          <header style={{marginBottom:12}}>
            <div>
              <h1>Quorum — Bread & Lesson Schedule</h1>
              <div className="muted small">Live: data pulled from your Google Sheet (auto-updates)</div>
            </div>
            <div className="actions">
              <button className="card small" onClick={()=>window.location.reload()}>Reload</button>
              <a className="card small" href="mailto:sterlingwbeck@gmail.com">Email Owner</a>
            </div>
          </header>

          <section className="card">
            <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
              <div>
                <strong>Schedule</strong>
                <div className="muted small">You can search or filter the table. Edits in the Google Sheet will appear automatically (within a minute).</div>
              </div>
              <div className="small muted">Status: {feed.loading ? 'loading...' : feed.error ? 'error: '+feed.error : 'OK'}</div>
            </div>

            <div className="controls">
              <input placeholder="Search table (any column)" value={query} onChange={e=>setQuery(e.target.value)} style={{minWidth:220}} />
              <div className="muted small">CSV source: <span className="small">{CSV_URL}</span></div>
            </div>

            <div style={{overflowX:'auto',marginTop:10}}>
              <table>
                <thead>
                  <tr>{feed.header.map((h,i)=>(<th key={i}>{h}</th>))}</tr>
                </thead>
                <tbody>
                  {filteredRows().map((row,ri)=> (
                    <tr key={ri}>{feed.header.map((h,ci)=>(<td key={ci}>{row[h]}</td>))}</tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div style={{display:'flex',gap:8,marginTop:12,flexWrap:'wrap'}}>
              <button className="small" onClick={()=>{navigator.clipboard?.writeText(CSV_URL);alert('CSV URL copied to clipboard')}}>Copy CSV URL</button>
              <button className="small" onClick={()=>{ const s = JSON.stringify({header:feed.header,data:feed.data}); const b=new Blob([s]); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='schedule.json'; a.click(); URL.revokeObjectURL(u); }}>Download JSON</button>
            </div>
          </section>

          <section style={{display:'grid',gridTemplateColumns:'1fr 360px',gap:12,marginTop:12}}>
            <div className="card">
              <strong>Contact / Email</strong>
              <div className="muted small">Send a message directly to sterlingwbeck@gmail.com — this will open your mail app.</div>
              <div style={{marginTop:8,display:'grid',gap:8}}>
                <input placeholder="Your name" value={contact.name} onChange={e=>setContact({...contact,name:e.target.value})} />
                <input placeholder="Your email" value={contact.email} onChange={e=>setContact({...contact,email:e.target.value})} />
                <input placeholder="Subject" value={contact.subject} onChange={e=>setContact({...contact,subject:e.target.value})} />
                <textarea placeholder="Message" rows={5} value={contact.message} onChange={e=>setContact({...contact,message:e.target.value})}></textarea>
                <div style={{display:'flex',gap:8}}>
                  <button onClick={emailOwner}>Send Email (opens mail client)</button>
                  <button onClick={()=>{alert('Optional: To get emailed forms directly, sign up for Formspree and replace the email flow. See deployment instructions below.')}}>Use Formspree</button>
                </div>
              </div>
            </div>

            <div className="card">
              <strong>Visitor Chat</strong>
              <div className="muted small">Visitors can start a thread. Threads are stored locally in your browser unless you enable Firebase (instructions below).</div>

              <div style={{marginTop:8}}>
                <StartThreadForm onStart={(n,e,m)=>startThread(n,e,m)} />
              </div>

              <div style={{marginTop:12}}>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center'}}>
                  <div className="muted small">Threads</div>
                  <div style={{display:'flex',gap:6}}>
                    <button onClick={exportChats} className="small">Export</button>
                    <button onClick={()=>{ if(confirm('Clear all local threads?')){ setChatsState([]); } }} className="small">Clear</button>
                  </div>
                </div>

                <div className="chat-list">
                  {chats.length===0 && <div className="muted small">No threads yet.</div>}
                  {chats.map(t=> (
                    <div key={t.id} className="chat-thread" onClick={()=>setActiveThreadId(t.id)} style={{border: activeThreadId===t.id ? '1px solid rgba(96,165,250,0.5)' : 'none',cursor:'pointer'}}>
                      <div style={{display:'flex',justifyContent:'space-between'}}>
                        <div><strong>{t.name}</strong> <span className="muted small">({t.email||'no email'})</span></div>
                        <div className="muted small">{new Date(t.created).toLocaleString()}</div>
                      </div>
                      <div className="small muted">{t.messages[t.messages.length-1]?.text.slice(0,120)}</div>
                    </div>
                  ))}
                </div>
              </div>

              <div style={{marginTop:12}}>
                <strong>Active Thread</strong>
                {!activeThreadId && <div className="muted small">Select a thread to view messages.</div>}
                {activeThreadId && (
                  <ThreadView thread={chats.find(c=>c.id===activeThreadId)} onSend={(txt)=>postMessageToActive(txt)} onClose={()=>setActiveThreadId(null)} />
                )}
              </div>
            </div>
          </section>

          <footer style={{marginTop:16,textAlign:'center'}} className="muted small">Built for Sterling. Deploy on GitHub Pages or Netlify. See the notes below for enabling live chat with Firebase and direct form handling via Formspree.</footer>

          <Notes />
        </div>
      );
    }

    function StartThreadForm({onStart}){
      const [name,setName] = useState(''); const [email,setEmail]=useState(''); const [message,setMessage]=useState('');
      return (
        <div style={{display:'grid',gap:6}}>
          <input placeholder="Your name" value={name} onChange={e=>setName(e.target.value)} />
          <input placeholder="Your email (optional)" value={email} onChange={e=>setEmail(e.target.value)} />
          <textarea placeholder="Start your question or concern" rows={3} value={message} onChange={e=>setMessage(e.target.value)} />
          <div style={{display:'flex',gap:6}}>
            <button onClick={()=>{ if(!message.trim()){ alert('Please enter a message.'); return; } onStart(name||'Visitor', email, message); setName(''); setEmail(''); setMessage(''); }}>Start Thread</button>
            <button onClick={()=>{ setName(''); setEmail(''); setMessage(''); }}>Clear</button>
          </div>
        </div>
      );
    }

    function ThreadView({thread,onSend,onClose}){
      const [txt,setTxt] = useState(''); const ref = useRef();
      useEffect(()=>{ if(ref.current) ref.current.scrollTop = ref.current.scrollHeight; },[thread]);
      if(!thread) return null;
      return (
        <div style={{display:'grid',gap:8}}>
          <div style={{maxHeight:140,overflow:'auto',padding:6,background:'rgba(255,255,255,0.01)',borderRadius:8}} ref={ref}>
            {thread.messages.map((m,i)=> (
              <div key={i} style={{marginBottom:6}}>
                <div style={{fontSize:12}}><strong className="small">{m.from}</strong> <span className="muted small">{new Date(m.time).toLocaleString()}</span></div>
                <div>{m.text}</div>
              </div>
            ))}
          </div>
          <div style={{display:'flex',gap:6}}>
            <input placeholder="Reply..." value={txt} onChange={e=>setTxt(e.target.value)} style={{flex:1}} />
            <button onClick={()=>{ if(!txt.trim()) return; onSend(txt); setTxt(''); }}>Send</button>
            <button onClick={onClose}>Close</button>
          </div>
        </div>
      );
    }

    function Notes(){
      return (
        <details style={{marginTop:18}} className="card">
          <summary style={{cursor:'pointer'}}>Deployment & Configuration Notes</summary>
          <div style={{marginTop:10}}>
            <h4>Mandatory: Google Sheet → Published CSV</h4>
            <p className="muted small">You've already provided the sheet and this app pulls from it. Any edits in Google Sheets will update the site on reload (and every minute while open).</p>

            <h4>To Deploy (GitHub Pages)</h4>
            <ol className="muted small">
              <li>Create a new GitHub repo (public) called <code>quorum-site</code>.</li>
              <li>Add a single file <code>index.html</code> containing this page's contents and commit.</li>
              <li>In repo settings, enable GitHub Pages from the main branch. The site will be available at <code>https://&lt;your-username&gt;.github.io/quorum-site/</code>.</li>
            </ol>

            <h4>Optional: Email forms (Formspree)</h4>
            <p className="muted small">If you want the contact form to send directly to your inbox without opening the visitor's mail app, sign up for Formspree (free tier) and replace the mailto flow with their form endpoint in the code. Formspree will give you an endpoint like <code>https://formspree.io/f/your-id</code>.</p>

            <h4>Optional: Real chat saved to the cloud (Firebase)</h4>
            <ol className="muted small">
              <li>Create a Firebase project at console.firebase.google.com and enable Firestore (Realtime Database also works).</li>
              <li>In project settings, copy the web SDK config and paste it into the <code>FIREBASE_CONFIG</code> variable at top of this file (replace null).</li>
              <li>Implement a tiny Firestore adapter to replace the localStorage functions (I can provide that code once you want remote chat).</li>
            </ol>

            <h4>Security & Privacy</h4>
            <p className="muted small">This page is intentionally lightweight and client-only. Visitor threads stored locally are private to the device that created them. If you enable Firebase, secure rules are required to prevent abuse — I'll provide sample rules if you want to go that route.</p>

            <h4>Need help deploying?</h4>
            <p className="muted small">Tell me where you want to host (GitHub / Netlify) and I will give step-by-step git commands and the exact file content to paste into <code>index.html</code> so it's ready-to-deploy.</p>
          </div>
        </details>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
